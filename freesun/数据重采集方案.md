## 数据重采集方案

### 一、方案前提

1. 支持的设备和协议范围
   - 确保在当前 IoT 平台的支持下，明确设备和协议的兼容性。对于**RTU**、**M24**、**振动设备**等主动上报的场景，需要在设备侧（硬件或固件）实现，而平台仅限软件功能，采集模式是基于**周期采集**的 `PingPong` 模式，主要是为满足数据定期刷新、冗余控制及重采的需求。
2. 扩展能力
   - 如果未来可能集成更多的主动上报设备（如 `LoRa`、NB-IoT 等），可以考虑通过 API 或 SDK 的方式接入到平台，**标准化**重采集接口。这样可以避免频繁变动设备端逻辑，同时为未来的扩展做准备。

### 二、触发条件

1. **采集异常**：
   - **采集超时**：当超过指定的采集时间窗口后仍未收到设备数据，视为采集失败，立即触发重采操作。
   - **采集错误**：例如**数据校验错误**（如 CRC 校验失败）、**数据格式错误**或**设备返回的错误码**，都可以直接触发重采。特别是要考虑在协议栈异常的情况下不触发重采，在连接未就绪的情况下，也不会触发重采集。
   - **动态超时配置**：可以根据设备种类、通信协议、网络状态（如弱信号或高延迟网络）动态调整采集超时，防止过于频繁触发重采。
2. **数据超量程**：
   - 在 DAC 侧设置合理的**量程上限和下限**，可以有效过滤掉超量程数据。处理逻辑上，若某一数据超出量程，则立即重采，避免数据异常上报影响后续处理。
3. **数据突变**：
   - **手动设定范围**：为保证精度和控制灵活性，可以在设备属性中引入“允许突变范围”的设定。如果突变超出该范围，则触发重采。
   - **自动识别**：采用如**z-score**等统计学算法，可以自动判定数据异常，但要结合设备历史数据和业务需求调整算法参数，确保不会将正常的数据误判为异常。可以基于滑动窗口对历史数据进行实时分析，自动计算异常阈值。

### 三、处理方式补充：

1. **重采集的执行逻辑**：

   - 在**driverCron.go**中，每个采集任务（DimCap）会根据设定的采集能力、重采次数和时间间隔来执行重采。核心逻辑是通过 `di = sd.driver.CallSync(&obj)` 同步采集数据。在每次采集之后，数据校验若发现异常则直接进入重采流程。

2. **分级重采策略**：

   - **局部重采**：如果仅某一维度的数据异常（如单个传感器），则只重采该维度的数据，避免对其他正常数据造成影响。
   - **全局重采**：在设备整体异常或数据严重失效的情况下，触发对整个设备（或采集单元）的重采，确保数据的完整性和一致性。

3. **异步处理与告警机制**：

   - 增加异步处理能力，减少在主采集任务中的等待时间。对需要重采的任务，可以通过异步队列处理，将其推送至后台任务中执行。

   - 在重采失败时，增加告警机制，触发通知或标记，告知用户数据采集存在问题。可以在数据返回中增加标识 “retry”

     ```json
     {
         "thingId": "db4d981c-30f1-4dbf-a9bf-dbd4c1c0e095",
         "dimensionId": "6c0536cc-21c7-41ba-8679-e7d5457bcec2",
         "dimCapId": "e6b8cee9-c917-4b80-a8a7-7f18bc199919",
         "capId": "5231b259-fa60-4021-8f7b-7837dae9f7f4",
         "deviceId": "39a49b40-0876-4661-bd6c-f113554c0033",
         "scheduleId": "856f6b6a-c6b4-4e34-82b6-d9f12918aae2",
         "taskId": "b44e6060-38ce-4807-b887-9b07efa9873f",
         "jobId": 1,
         "jobRepeatId": 1,
         "triggerTime": "2024-09-27T17:25:14+08:00",
         "realTime": "0001-01-01T00:00:00Z",
         "finishTime": "2024-09-27T17:25:15.340097263+08:00",
         "seq": 0,
         "released": false,
         "data": {
             "type": 1,
             "data": {
                 "cHumidity_Range": 0,
                 "cLiquid_level_L": 0,
             },
             "result": {
                 "code": 0,
                 "msg": "",
                 "detail": null,
                 "errTimes": 0,
                 "dropped": false,
                 "retry":0 // 重试次数
             }
         }
     }
     ```

     

### 四、风险补充：

1. 采集周期拉长风险
   - 对于频繁的重采需求，可能导致采集周期拉长，影响整体数据的**实时性**。在业务允许的情况下，可以考虑加大重采间隔，或设置不同设备的优先级进行分时采集，减少整体采集任务的延迟。
2. 算法误判风险
   - 自动异常识别算法，如使用 z-score 进行数据过滤，可能会误判正常数据为异常数据。因此，需要通过不断调整算法阈值、结合实际场景进行模型训练，尽量减少误判。
3. 采集设备幂等性
   - 确保设备能够处理多次幂等的采集请求。部分设备或三方数据源可能不支持幂等性操作，需提前确认并制定相应的处理方案（如标记操作唯一性等）。

### 五、总结：

总体而言，如果要应用重采集，限制会比较多，首先支持的采集模式只有主动下发采集（一般的DTU 485设备）。重采条件可以根据超时、超量程这些确定条件，如果要根据异常数据条件，需要在设备上增加异常范围判断的设置，自动识别异常的算法可能会误判。

