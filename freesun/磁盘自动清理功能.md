### 磁盘自动清理功能

#### 1. 项目概述

该功能用于对指定磁盘进行自动清理，主要根据磁盘剩余空间和文件的修改日期来决定清理哪些文件。此功能将定期检查磁盘的剩余空间，若空间不足，将自动删除过期文件。通过配置文件（`conf.yaml`）可以灵活配置不同磁盘的清理规则，包括清理阈值、数据保留天数以及需要清理的目录和子目录。

#### 2. 配置文件结构（`conf.yaml`）

```
yaml复制代码Disks:
  - Name: F:/
    # 磁盘剩余空间不足多少时进行清理（可配置为具体值，如 10%、100M、10.2GB 等）
    Clean: 1G
    # 数据保留天数，基于文件的修改时间进行清理，默认为 7 天
    RetentionDays: 10
    # 清理的目录配置，支持指定多个目录
    Dirs:
      - Path: ET/Data2
      - Path: ET
        # 针对特定目录，可以单独指定保留天数，覆盖全局配置
        RetentionDays: 3
        # 指定该目录下需要清理的子目录，其他子目录将不会被清理
        SubDirs:
          - Data
          - Parsed
          - Error
  - Name: G:/
    # 对于其他磁盘的清理配置
    Dirs:
      - Path: A
      - Path: B
      - Path: C
```

#### 3. 功能描述

1. **磁盘空间检测**：
   - 每次启动或者每小时定时，系统会检测指定磁盘的剩余空间。
   - 如果磁盘剩余空间低于设定阈值（如`1G`），则会触发清理过程。
   - `Clean`配置项支持不同单位，如字节（B）、KB、MB、GB、TB等。例如：`Clean: 1G`表示磁盘剩余小于1GB时触发清理。
   - 若未配置`Clean`，系统将默认依据文件的修改时间来进行清理。
2. **文件删除规则**：
   - 依据文件的修改时间和配置的保留天数`RetentionDays`，系统将清理超出保留天数的文件。
   - 若未指定`RetentionDays`，则默认保留7天内的文件。
3. **目录清理**：
   - 配置中的`Dirs`项指定了要清理的目录路径。
   - 可以为每个目录单独配置`RetentionDays`，如果该目录下的文件超出指定的天数，则会被删除。
   - `SubDirs`项可用于指定清理的子目录，只有指定的子目录会被清理，其他子目录保持不变。
4. **清理日志记录**：
   - 每次清理操作会生成清理日志，记录清理的文件、清理的时间和原因（如磁盘空间不足或超出保留天数）。

#### 4. 清理流程

1. **启动清理检查**：
   - 系统定时执行清理任务，或者可以手动触发清理。
   - 检查每个磁盘的剩余空间，判断是否低于阈值。
2. **判断是否需要清理**：
   - 如果磁盘剩余空间低于阈值，则触发清理。
   - 如果没有触发清理，则继续等待下一次检查。
3. **清理符合条件的文件**：
   - 根据配置的`RetentionDays`和文件的修改时间，删除超出保留天数的文件。
   - 对于指定的子目录，仅删除在`SubDirs`配置中列出的目录下的文件，其他目录不受影响。
4. **记录清理操作**：
   - 每次清理后，系统会将清理结果（如删除的文件路径和清理的原因）记录到日志文件中。

#### 5. 错误处理

- **磁盘不可访问**：
  - 若磁盘无法访问或出现I/O错误，系统会记录错误信息并通知管理员。
- **配置文件格式错误**：
  - 如果配置文件`conf.yaml`格式错误或缺少必要的字段，系统会抛出配置错误提示并终止执行。

#### 6. 开发环境

- **开发语言**：Go
- **代码路径**：SVN http://10.8.30.22/FS-Anxinyun/trunk/codes/services/tools/本地化进程看门狗/checkBoom
- **构建路径**：https://jenkins.ngaiot.com/job/fscheck/
- **配置文件路径**：`conf.yaml`

#### 7. 使用说明

1. 配置清理规则：
   - 修改`conf.yaml`配置文件，指定需要清理的磁盘、目录、清理阈值以及文件保留天数。
2. 启动清理：
   - 运行Go程序，系统将根据配置文件启动清理任务。
   - 可以手动或定时触发清理操作。
3. 查看日志：
   - 清理完成后，可以查看日志文件，确认清理操作的结果。