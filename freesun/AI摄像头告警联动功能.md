## 告警联动功能说明文档

### 平台：安心云4.0

### 代码路径：

```
\FS-Anxinyun\trunk\codes\services\alarm
```

### 构建链接：

[构建链接](https://jenkins.ngaiot.com/job/alarm-flink/)

### 脚本：`create_alarm_link.sql`

```sql
create table t_alarm_link
(
	id serial not null
		constraint t_alarm_link_pk
			primary key,
	strategy jsonb not null
);
```

### 功能说明：

AI摄像头告警联动功能允许根据不同的告警源和告警类型，在满足特定条件的情况下触发联动操作。该功能通过在数据库中存储联动策略配置，并通过时间窗、触发器、和操作等配置项，来定义在不同告警触发时的行为。

### 1. 联动策略配置：`strategy` 字段

`strategy` 字段存储联动策略的配置，以 `JSONB` 格式存储。策略配置包括以下几个部分：

#### 1.1 联动策略配置示例

```json
{
  "name": "AI摄像头联动",  // 用于日志记录的策略名称
  "time_window": "2 hours", // 时间窗（所有条件满足时间在2小时内）
  "triggers": [            // 触发条件数组
    {
      "source": "abc",     // 告警源（设备ID或测点ID）
      "alarm_type": "3007" // 告警类型
    },
    {
      "source": "2",
      "alarm_type": "2031"
    }
  ],
  "actions": [            // 执行动作数组
    {
      "type": "iot-cap",  // 固定值：以太能力调用
      "parameters": {
        "body": {
          "deviceId": "12345678980",
          "thingId": "12345678980",
          "dimCapId": "12345678980",
          "timeout": 10000,
          "param": "{\"a\":21}"
        }
      }
    }
  ]
}
```

#### 1.2 配置字段说明：

- **name**: 策略名称，用于日志记录。

- **time_window**: 时间窗配置，表示在这个时间段内所有条件必须满足才能触发联动。

- triggers

  : 触发器列表。每个触发器都指定了一个告警源和告警类型，触发器的条件满足时，会触发后续的联动操作。

  - `source`: 告警源，可以是设备ID或测点ID。
  - `alarm_type`: 告警类型，用于匹配具体的告警事件。

- actions

  : 动作列表。每个动作都定义了在触发告警后需要执行的操作。

  - `type`: 动作类型，这里固定为 `iot-cap`，即以太能力调用。
  - `parameters`: 参数配置，具体动作的执行细节，包括设备ID、超时时间、以及传递的参数。

### 2. 联动策略触发与执行流程：

- 在系统运行时，如果收到符合触发条件的告警事件，系统会检查是否满足时间窗（`time_window`）要求。
- 如果满足时间窗内的条件，系统会执行相应的动作（如触发以太能力调用）。

### 3. 数据库表结构：

表 `t_alarm_link` 用于存储所有的告警联动策略配置。

#### 3.1 表字段说明：

- **id**: 主键，自动递增的唯一标识符。
- **strategy**: 存储联动策略的配置，采用 `jsonb` 格式。

### 4. 使用说明：

1. 在 `create_alarm_link.sql` 中定义了数据库表结构，在初始化数据库时执行该脚本以创建 `t_alarm_link` 表。
2. 在平台的告警管理模块中配置不同的联动策略，每个策略会通过 `strategy` 字段存储相关的触发器与动作配置。
3. 系统会自动监听告警事件，根据配置的触发条件与时间窗来判断是否执行联动操作。

### 5. 示例操作：

当设备 `abc` 触发类型为 `3007` 的告警，且设备 `2` 触发类型为 `2031` 的告警在 `2小时` 的时间窗内满足时，系统会触发一个以太能力调用动作。